name: Sync Upstream Open WebUI

on:
  # æ¯å¤©UTCæ—¶é—´00:00è‡ªåŠ¨è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add upstream remote and fetch
      run: |
        git remote add upstream https://github.com/open-webui/open-webui || true
        git fetch upstream

    - name: Check available branches
      run: |
        echo "=== æœ¬åœ°åˆ†æ”¯ ==="
        git branch -a
        echo "=== ä¸Šæ¸¸åˆ†æ”¯ ==="
        git ls-remote --heads upstream

    - name: Detect and verify branches
      id: detect_branches
      run: |
        # è·å–å½“å‰åˆ†æ”¯
        CURRENT_BRANCH=$(git branch --show-current)
        echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
        echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
        
        # æ£€æµ‹ä¸Šæ¸¸åˆ†æ”¯ï¼ˆä¼˜å…ˆæ£€æŸ¥mainï¼Œç„¶åmasterï¼‰
        if git ls-remote --exit-code --heads upstream main; then
          UPSTREAM_BRANCH="main"
        elif git ls-remote --exit-code --heads upstream master; then
          UPSTREAM_BRANCH="master"
        else
          echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ°ä¸Šæ¸¸çš„ main æˆ– master åˆ†æ”¯"
          echo "å¯ç”¨çš„ä¸Šæ¸¸åˆ†æ”¯:"
          git ls-remote --heads upstream
          exit 1
        fi
        
        echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
        echo "âœ… ä¸Šæ¸¸åˆ†æ”¯: $UPSTREAM_BRANCH"

    - name: Check for changes
      id: check_changes
      run: |
        CURRENT_BRANCH="${{ steps.detect_branches.outputs.current_branch }}"
        UPSTREAM_BRANCH="${{ steps.detect_branches.outputs.upstream_branch }}"
        
        LOCAL=$(git rev-parse HEAD)
        REMOTE=$(git rev-parse upstream/$UPSTREAM_BRANCH)
        
        echo "æœ¬åœ° $CURRENT_BRANCH æäº¤: $LOCAL"
        echo "ä¸Šæ¸¸ $UPSTREAM_BRANCH æäº¤: $REMOTE"
        
        if [ "$LOCAL" != "$REMOTE" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "âœ… å‘ç°ä¸Šæ¸¸ Open WebUI æœ‰æ–°çš„æ›´æ–°"
          
          # æ˜¾ç¤ºå°†è¦åŒæ­¥çš„æäº¤
          echo "=== æ–°æäº¤é¢„è§ˆ ==="
          git log --oneline $LOCAL..$REMOTE || echo "æ— æ³•æ˜¾ç¤ºæäº¤å·®å¼‚"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  ä¸Šæ¸¸ Open WebUI æ²¡æœ‰æ–°çš„æ›´æ–°"
        fi

    - name: Merge upstream changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        CURRENT_BRANCH="${{ steps.detect_branches.outputs.current_branch }}"
        UPSTREAM_BRANCH="${{ steps.detect_branches.outputs.upstream_branch }}"
        
        echo "ğŸ”„ å¼€å§‹åˆå¹¶ upstream/$UPSTREAM_BRANCH åˆ°æœ¬åœ° $CURRENT_BRANCH åˆ†æ”¯"
        git merge upstream/$UPSTREAM_BRANCH --no-edit --allow-unrelated-histories
        echo "âœ… åˆå¹¶å®Œæˆ"
        
    - name: Push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        CURRENT_BRANCH="${{ steps.detect_branches.outputs.current_branch }}"
        echo "ğŸ“¤ æ¨é€æ›´æ–°åˆ° origin/$CURRENT_BRANCH"
        git push origin $CURRENT_BRANCH
        echo "âœ… æ¨é€å®Œæˆ"
        
    - name: Create Pull Request on conflict
      if: failure() && steps.check_changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: sync-upstream-openwebui-${{ github.run_number }}
        base: ${{ steps.detect_branches.outputs.current_branch }}
        title: "ğŸ”„ åŒæ­¥ Open WebUI ä¸Šæ¸¸æ›´æ–°ï¼ˆæœ‰å†²çªï¼‰"
        body: |
          ## ğŸ“‹ åŒæ­¥ä¿¡æ¯
          
          è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„PRï¼Œç”¨äºåŒæ­¥ Open WebUI ä¸Šæ¸¸ä»“åº“çš„æ›´æ–°ã€‚
          
          âš ï¸ **ç”±äºå­˜åœ¨å†²çªï¼Œæ— æ³•è‡ªåŠ¨åˆå¹¶ï¼Œè¯·æ‰‹åŠ¨è§£å†³å†²çªååˆå¹¶æ­¤PRã€‚**
          
          - ä¸Šæ¸¸ä»“åº“: https://github.com/open-webui/open-webui
          - åŒæ­¥åˆ†æ”¯: ${{ steps.detect_branches.outputs.current_branch }} â† upstream/${{ steps.detect_branches.outputs.upstream_branch }}
          
          ## ğŸ“ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹commitsäº†è§£å…·ä½“æ›´æ–°å†…å®¹ã€‚
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - è¿™æ˜¯Open WebUIåº”ç”¨çš„æ›´æ–°
          - è¯·æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®æ–‡ä»¶å˜æ›´
          - è¯·æ£€æŸ¥ä¾èµ–é¡¹å’Œç¯å¢ƒå˜é‡å˜æ›´
          - å¯èƒ½åŒ…å«æ–°çš„åŠŸèƒ½ã€UIæ”¹è¿›æˆ–å®‰å…¨æ›´æ–°
          - å¦‚æœ‰è‡ªå®šä¹‰é…ç½®æˆ–ä¸»é¢˜ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å—å½±å“
          - åˆå¹¶å‰å»ºè®®å…ˆåœ¨æœ¬åœ°æµ‹è¯•åº”ç”¨åŠŸèƒ½
          - è¯·æ³¨æ„æ£€æŸ¥åç«¯APIå˜æ›´æ˜¯å¦å½±å“å‰ç«¯åŠŸèƒ½
          
          ## ğŸ”§ è§£å†³å†²çªæ­¥éª¤
          1. åœ¨æœ¬åœ°æ‹‰å–è¿™ä¸ªåˆ†æ”¯
          2. æ‰‹åŠ¨è§£å†³å†²çª
          3. æµ‹è¯•åº”ç”¨åŠŸèƒ½ï¼ˆåŒ…æ‹¬å‰åç«¯äº¤äº’ï¼‰
          4. æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡
          5. ç¡®è®¤æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ååˆå¹¶PR
          
        labels: |
          sync
          automated
          open-webui
          ui
